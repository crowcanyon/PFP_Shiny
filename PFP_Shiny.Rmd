---
title: "![](CCAC_logo_vector.svg) The Pueblo Farming Project"
subtitle: |
  | A collaboration between Hopi Farmers and 
  | Crow Canyon Archaeological Center
author: Kyle Bocinsky, Paul Ermigiotti, Grant Coffey, and Mark Varien
date: "`r format(Sys.time(), '%B %d, %Y')`"
output: 
  html_document: 
    theme: sandstone
    css: PFP_Shiny.css
    toc: yes
    toc_depth: 4
    toc_float:
      collapsed: no
runtime: shiny
---

This is an exploratory data analysis of the Pueblo Farming Project (PFP) data from the 2009--2015 growing seasons.

```{r, echo=FALSE, results="hide", message=FALSE}
## Load the R packages we are going to use
library(dplyr)
library(lubridate)
library(sp)
# library(plotly)

## Load the data, processed by PFP_data_prep.R
# growth <- readr::read_csv("./growth.csv")
# Soils data
soils <- rgdal::readOGR(dsn = "./data/soils.geojson", "OGRGeoJSON", verbose = FALSE)
soil_moisture <- readr::read_csv("./data/soil_moisture.csv")
soils_VEPII_yields <- rgdal::readOGR(dsn = "./data/soils_VEPII_yields.geojson", "OGRGeoJSON", verbose = FALSE)
soils <- sp::spTransform(soils, soils_VEPII_yields@proj4string)

# Weather data
cortez_weather <- readr::read_csv("./data/cortez_weather.csv")
weather_stations <- readr::read_csv("./data/weather_stations.csv")
weather_stations_sp <- rgdal::readOGR(dsn = "./data/weather_stations.geojson", "OGRGeoJSON", verbose = FALSE)

# Garden data
garden_locations <- rgdal::readOGR(dsn = "./data/gardens.geojson", "OGRGeoJSON", verbose = FALSE)
garden_locations$color <- RColorBrewer::brewer.pal(length(garden_locations),"Dark2")
growth_summaries <- readr::read_csv("./data/growth_summaries.csv") %>%
  dplyr::filter(Garden != "MCG")
ears <- readr::read_csv("./data/ears.csv")
yields <- readr::read_csv("./data/yields.csv")

```

## Introduction
Introduction to the Pueblo Farming Project. When it took place. Who started it?

### What is the PFP?
What do we want to learn?

### Who participated?
Participants through the years. Hopi collaborators. VEP.

### Where are the PFP gardens?
Five PFP gardens are scattered around Crow Canyon Archaeological Center's rural campus in Cortez, Colorado. Click on the markers to explore the gardens!

In 2015, we planted a new garden in the "bean fields" north of Crow Canyon's campus. This garden, called the Mike Coffey Garden (named after our friend Mike who donated the land for use to farm), is much higher in elevation than the Crow Canyon gardens.
```{r, echo=FALSE}
garden_locations@data <- cbind(garden_locations@data, rgeos::gCentroid(garden_locations, byid=T)@coords)

gardens_m <- leaflet::leaflet(garden_locations, width = "100%") %>%
  leaflet::addProviderTiles("Esri.WorldImagery", group = "Satellite") %>%
  leaflet::addProviderTiles("Esri.WorldTopoMap", group = "Topography") %>%
  leaflet::addMarkers(lng = ~x,
                      lat = ~y,
                      popup = ~Popup
  ) %>%
  leaflet::addLayersControl(
    baseGroups = c("Satellite", "Topography"),
    options = leaflet::layersControlOptions(collapsed = T)
  )

gardens_m  # Print the map

```


## How corn grows
Basics of corn phenology. Parts of corn. Growth stages.

### Does soil matter?
Nutrients. Water. Direct-precipitation (rain-fed) farming.

#### Soils in the PFP gardens
NRCS SSURGO soils. Comparison with surrounding area, including ICR.

```{r, echo = FALSE}
## Define the display layers
display_layers <- paste0("X",2009:2015)
names(display_layers) <- 2009:2015

## Create color palettes for each soil layer
colorpal <- leaflet::colorNumeric(
      palette = "RdYlGn",
      c(0,700))

## Create map that allows people to color by different layers
# Create the basemap
yields_m <- leaflet::leaflet(soils_VEPII_yields, width = "100%") %>%
  leaflet::addProviderTiles("Esri.WorldImagery", group = "Satellite")

# Add layers for each soil quality
# i <- 2
for(i in 1:length(display_layers)){
  yields_m <- yields_m %>%
    leaflet::addPolygons(fillColor = ~colorpal(soils_VEPII_yields[[display_layers[i]]]),
                         fillOpacity = 0.7,
                         color = "white",
                         weight = 3,
                         opacity = 1,
                         smoothFactor = 0.5,
                         popup = ~Popup,
                         group = names(display_layers)[i]
    )
}

# Add a layer for gardens
yields_m <- yields_m %>%
  leaflet::addMarkers(data = garden_locations,
                      lng = ~x,
                      lat = ~y,
                      popup = ~Popup,
                      group = "Gardens"
  )

## Add the control box
yields_m <- yields_m %>% leaflet::addLayersControl(
    baseGroups = names(display_layers),
    overlayGroups = c("Gardens"),
    options = leaflet::layersControlOptions(collapsed = T, autoZIndex = F)
  )

## Add the legend
yields_m <- yields_m  %>%
        leaflet::addLegend(position = "bottomright",
                  pal = colorpal, values = c(0,700))

## Fit the bounds to the soils
yields_m <- yields_m  %>%
  leaflet::fitBounds(lng1 = raster::xmin(soils_VEPII_yields),
            lat1 = raster::ymin(soils_VEPII_yields),
            lng2 = raster::xmax(soils_VEPII_yields),
            lat2 = raster::ymax(soils_VEPII_yields))

yields_m  # Print the map
```

#### Soil moisture and temperature
UNT project. Soil moisture for photosynthesis. Temperature for seedling development.

```{r, echo=FALSE}
shiny::inputPanel(
  shiny::selectInput("the_var_soil_moisture", label = "Soil measurement:",
                     choices = c("Moisture","Temperature")),
  #   
  #   shiny::selectInput("the_display_soil_moisture", label = "Display by:",
  #                      choices = c("Garden","Depth")),
  
  shiny::selectInput("the_garden_soil_moisture", label = "Garden/Location:",
                     choices = unique(gsub(" — NA","",paste0(soil_moisture$Garden," — ",soil_moisture$Location)))),
  
  shiny::checkboxInput("freeze_y_soil_moisture", label = "Freeze y scale?", value = TRUE)
  
)

output$download_soil_moisture <- shiny::downloadHandler(
      filename = function() {
        "soil_moisture.csv"
      },
      content = function(con) {
        readr::write_csv(soil_moisture, con)
      }
    )

shiny::renderPlot({
  garden <- strsplit(input$the_garden_soil_moisture," — ")[[1]][1]
  loc <- strsplit(input$the_garden_soil_moisture," — ")[[1]][2]
  
  moisture_data <- soil_moisture %>%
    dplyr::filter(Garden == garden)
  
  if(!is.na(loc)){
    moisture_data <- moisture_data %>%
      dplyr::filter(Location == loc)
  }
  
  if(input$the_var_soil_moisture == "Moisture"){
    moisture_data <- moisture_data %>%
      dplyr::select(Time,contains("VWC")) %>%
      reshape2::melt(id.vars="Time")
    
    # the_range <- soil_moisture %>% ungroup() %>% select(contains("VWC")) %>% range()
    the_range <- c(0.05,0.35)
  }else{
    moisture_data <- moisture_data %>%
      dplyr::select(Time,contains("Temp")) %>%
      reshape2::melt(id.vars="Time")
    
    # the_range <- soil_moisture %>% ungroup() %>% select(contains("Temp")) %>% range()
    the_range <- c(32,85)
  }
  
  # xrange <- range(moisture_data$Time)
  xrange <- as.POSIXct(c("2015-06-01 UTC","2016-03-01 UTC"))
  
  soil_moisture_plot <- ggplot2::ggplot() + 
    ggplot2::ggtitle(paste0("Soil ",input$the_var_soil_moisture,": ", input$the_garden_soil_moisture)) +
    ggplot2::theme(axis.text = ggplot2::element_text(size=14),
                   axis.title = ggplot2::element_text(size=16,face="bold"),
                   legend.title = ggplot2::element_text(size=16,face="bold"),
                   legend.text = ggplot2::element_text(size=14),
                   plot.title = ggplot2::element_text(size=18,face="bold")) + 
    ggplot2::xlab("Date") + 
    ggplot2::xlim(xrange)
  
  if(input$freeze_y_soil_moisture){
        soil_moisture_plot <- soil_moisture_plot +
          ggplot2::ylim(the_range)
  }
  
  soil_moisture_plot <- soil_moisture_plot + 
      ggplot2::geom_line(data = moisture_data,
                         ggplot2::aes(y = value, 
                             x = Time,
                             col=variable
                         ),
                         size=2)
  
  if(input$the_var_soil_moisture == "Moisture"){
    soil_moisture_plot <- soil_moisture_plot + 
      ggplot2::ylab(bquote('Volumetric water content ('*m^3/m^3*')')) +
      ggplot2::scale_colour_hue(name="Depth",
                         breaks=c("VWC_15", "VWC_30", "VWC_45"),
                         labels=c('15 cm', '30 cm', '45 cm'))
    
#     if(input$show_precip){
#       this_weather_plot <- cortez_weather %>%
#         dplyr::filter(DATE %within% (min(moisture_data$Time)%--%max(moisture_data$Time)))
#       soil_moisture_plot <- soil_moisture_plot + 
#         ggplot2::geom_linerange(data = this_weather_plot, aes(x=DATE, ymin = 0, ymax = PRCP_IN)) + 
#         ggplot2::ylab(paste0(bquote('Volumetric water content ('*m^3/m^3*')'),'\n —and— \n Cortez precipitation (inches)'))
#     }else{
      soil_moisture_plot <- soil_moisture_plot + 
        ggplot2::ylab(bquote('Volumetric water content ('*m^3/m^3*')'))
    # }
    
  }else{
    soil_moisture_plot <- soil_moisture_plot + 
      ggplot2::ylab("Temperature (ºF)") +
      ggplot2::scale_colour_hue(name="Depth",
                         breaks=c("Temp_15", "Temp_30", "Temp_45"),
                         labels=c('15 cm', '30 cm', '45 cm'))
  }
  
  soil_moisture_plot
  
}, width = "auto", height = 450)

shiny::downloadLink(outputId = 'download_soil_moisture', label = 'Download soil moisture data')

```


### Does weather matter?
Precipitation and temperature. Local. Cold air drainage.

#### Measuring accumulated heat---GDD
What is a GDD? Equation. Heat and photosynthesis. GDD needs of traditional and modern corn varieties. Killing Degree Days?

The equation for daily GDD is:
$$ GDD=\frac{T_{MAX} + T_{MIN}}{2}-T_{BASE} $$
where $T_{MAX}$ is the maximum daily temperature, $T_{MIN}$ is the minimum daily temperature and $T_{BASE}$ is the temperature below which plant growth ceases, which we take to be 10°C for maize.

Here we use a series of corrections to equation typically applied for calculating maize GDD, which down-corrects $T_{MAX}$ and $T_{MIN}$ to an upper threshold ($T_{UT}$, here 30°C) above which corn growth does not appreciably increase, and up-corrects $T_{MAX}$ and $T_{MIN}$ if they fall below $T_{BASE}$ (here 10°C). To summarize:
$$
\text{if} \quad T_{MAX}>T_{UT}, \quad T_{MAX}=T_{UT}\\
\text{if} \quad T_{MIN}>T_{UT}, \quad T_{MIN}=T_{UT}\\
\text{if} \quad T_{MAX}<T_{BASE}, \quad T_{MAX}=T_{BASE}\\
\text{if} \quad T_{MIN}<T_{BASE}, \quad T_{MIN}=T_{BASE}
$$

GDDs can be converted from Celcius heat units to Fahrenheit heat units by multiplying by a factor of 1.8.

#### Weather in Cortez
Weather station location. Cooperative (COOP) database. GHCN. Cortez station graph.

```{r, echo=FALSE}
cortez_weather_dy <- cortez_weather %>%
                      dplyr::select(TMAX_F, TMIN_F, FGDD, PRCP_IN) %>%
                      as.data.frame()
row.names(cortez_weather_dy) <- cortez_weather$DATE

dygraphs::renderDygraph({
  dygraphs::dygraph(cortez_weather_dy %>% dplyr::select(TMAX_F, TMIN_F, FGDD),
                    group = "cortez") %>%
    dygraphs::dyAxis('y',
                     label = "Temperature (ºF)",
                     drawGrid = F,
                     independentTicks = T) %>%
    dygraphs::dyAxis('y2',
                     label = "Daily GDD (F)",
                     valueRange = c(0, 30),
                     drawGrid = F,
                     independentTicks = T) %>%
    dygraphs::dyAxis('x',
                     drawGrid = F) %>%
    # dygraphs::dySeries("Precipitation (in)", axis = 'y2', stemPlot = T, drawPoints = F, strokeWidth = 1, pointSize = NA, color = "black") %>%
    dygraphs::dySeries("TMAX_F", label = "Maximum temperature (ºF)", axis = 'y', color = "#ef8a62", strokeWidth = 1.5) %>%
    dygraphs::dySeries("TMIN_F", label = "Minimum temperature (ºF)", axis = 'y', color = "#67a9cf", strokeWidth = 1.5) %>% 
    dygraphs::dySeries("FGDD", label = "GDD (F)", axis = "y2", color = "black") %>%
    dygraphs::dyLegend(labelsSeparateLines = T, show = "onmouseover") %>%
    dygraphs::dyRangeSelector(dateWindow = c("2015-01-01", "2015-12-31"))
  
})

cortez_weather_dy$PRCP_IN2 <- cortez_weather_dy$PRCP_IN

dygraphs::renderDygraph({
  dygraphs::dygraph(cortez_weather_dy %>% dplyr::select(PRCP_IN, PRCP_IN2), group = "cortez") %>%
    dygraphs::dyAxis('y',
                     label = "Precipitation (in)",
                     valueRange = c(0, NULL),
                     drawGrid = F,
                     independentTicks = T) %>%
    dygraphs::dyAxis('y2',
                     label = "Precipitation (in)",
                     valueRange = c(0, NULL),
                     drawGrid = F,
                     independentTicks = T) %>%
    dygraphs::dyAxis('x',
                     drawGrid = F) %>%
    dygraphs::dySeries("PRCP_IN", label = "Precipitation (in)", axis = 'y', stemPlot = T, drawPoints = F, strokeWidth = 1, pointSize = NA, color = "black") %>%
    dygraphs::dyLegend(show = "onmouseover") %>%
    dygraphs::dySeries("PRCP_IN2", label = "Precipitation (in) 2", axis = 'y2', stemPlot = T, drawPoints = F, strokeWidth = 0, pointSize = NA, color = "black") %>%
    dygraphs::dyRangeSelector(dateWindow = c("2015-01-01", "2015-12-31")) 
})

```

<!-- 
#### Weather in the PFP gardens
Temperature monitors and weather station locations. Spotty record. Interactive TS plot of both. Does it capture cold air drainage?

```{r, echo=FALSE}
suppressWarnings(weather_stations_dy <- weather_stations %>%
  dplyr::left_join(weather_stations_sp@data %>% dplyr::select(ID, Abbreviation), by = c("Location" = "ID")) %>%
  dplyr::filter(Abbreviation != "East_Hill") %>%
  dplyr::select(-Location))


shiny::inputPanel(
  shiny::selectInput("the_garden_weather_stations",
                     label = "Garden:",
                     choices = c("Check Dam Garden" = "CDG",
                                 "Karen's Upper Garden" = "KUG",
                                 "Pithouse Garden" = "PHG",
                                 "Paul's Old Garden" = "POG",
                                 "Pueblo Learning Center Garden" = "PLC")
  )
)

weather_stations_dy_this <- shiny::reactive({
  suppressMessages(weather_stations_dy_this <- weather_stations_dy %>%
    dplyr::filter(Abbreviation == input$the_garden_weather_stations) %>%
    dplyr::arrange(Date_Time) %>%
    as.data.frame())
  
  row.names(weather_stations_dy_this) <- round.POSIXt(weather_stations_dy_this$Date_Time, "day")

  weather_stations_dy_this <- weather_stations_dy_this %>%
    dplyr::select(-Date_Time)
  
  weather_stations_dy_this
})

dygraphs::renderDygraph({
  the_graph <- weather_stations_dy_this() %>% 
    dplyr::select(TMAX, TMIN, FGDD) %>%
    as.data.frame()
  dygraphs::dygraph(the_graph) %>%
    dygraphs::dyAxis('y',
                     label = "Temperature (ºF)",
                     drawGrid = F,
                     independentTicks = T) %>%
    dygraphs::dyAxis('y2',
                     label = "Daily GDD (F)",
                     valueRange = c(0, 30),
                     drawGrid = F,
                     independentTicks = T) %>%
    dygraphs::dyAxis('x',
                     drawGrid = F) %>%
    dygraphs::dySeries("TMAX",
                       label = "Maximum temperature (ºF)",
                       axis = 'y',
                       color = "#ef8a62",
                       strokeWidth = 1.5) %>%
    dygraphs::dySeries("TMIN",
                       label = "Minimum temperature (ºF)",
                       axis = 'y',
                       color = "#67a9cf",
                       strokeWidth = 1.5) %>% 
    dygraphs::dySeries("FGDD",
                       label = "GDD (F)",
                       axis = "y2",
                       color = "black") %>%
    dygraphs::dyLegend(labelsSeparateLines = T,
                       show = "onmouseover") %>%
    dygraphs::dyRangeSelector(dateWindow = c("2015-01-01", "2015-12-31"))
  
})

```
-->

## The PFP Field Experiments
2008--2015. 2008 recorded differently, so only 2009--2015 data presented here. 

### How well did the corn grow?
Our first analysis is of maize growth in the gardens over each growing season. Growth is measured as the proportion of clumps with plants reaching a particular growth stage, at a particular point in time. Select a year and a growth stage, and choose whether you'd like the date or the accumulated Fahrenheit growing degree days (FGDDs) to plot on the horizontal axis.

```{r, echo=FALSE}
shiny::inputPanel(
  shiny::selectInput("the_year", label = "Growing season:",
                     choices = seq(2009,2015,1), selected = 2009),
  
  shiny::selectInput("the_var", label = "Developmental stage:",
                     choices = c("Early tassel development"="Early Tassel Development","Tassel development"="Tassel Development","Tasseling"="Tasseling","Silk development"="Silk Development","Silking"="Silking","Ear development"="Ear Development")),
  
  shiny::selectInput("x_axis", label = "Horizontal axis units:",
                     choices = c("Date","Accumulated FGDD")),
  
  shiny::selectInput("color", label = "Color by:",
                     choices = c("Garden"="Garden","Maize variety"="Variety")),
  
  shiny::checkboxInput("show_precip", label = "Show precipitation?", value = TRUE)
)

output$download_growth_summaries <- shiny::downloadHandler(
      filename = function() {
        "growth_summaries.csv"
      },
      content = function(con) {
        readr::write_csv(growth_summaries, con)
      }
    )

shiny::renderPlot({
  growth_plot <- growth_summaries%>%
    dplyr::filter(lubridate::year(Date) == input$the_year)
  
  if(input$show_precip){
    weather_plot <- cortez_weather %>%
      dplyr::filter(DATE %within% (min(growth_plot$Date)%--%max(growth_plot$Date)))
  }
  
  p <- ggplot2::ggplot() +
    ggplot2::ylim(0,1) +
    ggplot2::ggtitle(input$the_var) +
    ggplot2::theme(axis.text = ggplot2::element_text(size=14),
                   axis.title = ggplot2::element_text(size=16,face="bold"),
                   legend.title = ggplot2::element_text(size=16,face="bold"),
                   legend.text = ggplot2::element_text(size=14),
                   plot.title = ggplot2::element_text(size=18,face="bold"))
  
  if(input$x_axis == "Date"){
    p <- p + ggplot2::xlab("Date")
    
    if(input$show_precip){
      p <- p + 
        ggplot2::geom_linerange(data = weather_plot, ggplot2::aes(x=DATE, ymin = 0, ymax = PRCP_IN)) + 
        ggplot2::ylab("Proportion of clumps with plants at stage\n —and— \n precipitation in Cortez (inches)")
    }else{
      p <- p + ggplot2::ylab("Prop. of clumps with plants at stage")
    }
    
    p <- p + 
      ggplot2::geom_line(data=growth_plot, ggplot2::aes(Date, get(input$the_var), group=Garden, colour=get(input$color)))
    
  }else if(input$x_axis == "Accumulated FGDD"){
    
    p <- p + 
      ggplot2::xlab("Fahrenheit Growing Degree Days since planting") +
      ggplot2::ylab("Proportion of clumps with plants at stage") + 
      ggplot2::geom_line(data=growth_plot, ggplot2::aes(Acc_FGDD, get(input$the_var), group=Garden, colour=get(input$color)))
    
  }
  
  p <- p +
    ggplot2::scale_colour_discrete(name = input$color)
  
  p

}, width = "auto", height = 450)

shiny::downloadLink(outputId = 'download_growth_summaries', label = 'Download growth summary data')


# ### And print the table
# # a custom table container
# sketch = htmltools::withTags(table(
#   class = 'display',
#   thead(
#     tr(
#       th(rowspan = 2, 'Measurement Date'),
#       th(rowspan = 2, 'Garden'),
#       th(rowspan = 2, 'Variety'),
#       th(colspan = 6, 'Growth stage')
#     ),
#     tr(
#       lapply(c('Early Tassel Development', 'Tassel Development', 'Tasseling', 'Silk Development', 'Silking', 'Ear Development'), th)
#     )
#   )
# ))
# 
# growth_summaries_table <- growth_summaries %>% 
#   dplyr::mutate(Garden = as.factor(Garden), Date = as.Date(Date)) %>%
#   dplyr::select(Date, Garden, Variety, `Early Tassel Development`:`Ear Development`,-Season,-Acc_FGDD) %>%
#   dplyr::arrange(Garden,Date)
# growth_summaries_table[,4:9] <- apply(X = growth_summaries_table[,4:9],MARGIN = 2,FUN = round,digits=2)
# 
# DT::datatable(growth_summaries_table,
#               extensions = c("Scroller"),
#               options = list(
#                 pageLength = 10,
#                 autoWidth = TRUE,
#                 searching = FALSE,
#                 dom = "rftiS",
#                 scrollCollapse = TRUE,
#                 scrollY = 400,
#                 scrollX = FALSE,
#                 deferRender = TRUE
#               ),
#               caption = 'Table 1: Proportion of clumps with plants at growth stages.',
#               container = sketch,
#               rownames = FALSE
# )
```

### How much corn was produced?
Graphs like those that Dylan produced, showing variation over seasons. 

#### Ear diversity
How big were the ears, given different corn types and different gardens? What is a distribution? How to read a box plot.

```{r, echo=FALSE}

shiny::inputPanel(
  shiny::selectInput("the_year_ears", label = "Growing season:",
                     choices = seq(2009,2015,1), selected = 2009),
  
  shiny::selectInput("the_var_ears", label = "Measurement:",
                     choices = c("Ear weight","Cob weight","Kernel weight")),
  
  shiny::selectInput("color_ears", label = "Color by:",
                     choices = c("Garden"="Garden","Maize variety"="Variety")),
  
  shiny::checkboxInput("freeze_y_ears", label = "Freeze y scale?", value = TRUE)
)

output$download_ears <- shiny::downloadHandler(
      filename = function() {
        "ears.csv"
      },
      content = function(con) {
        readr::write_csv(ears, con)
      }
    )

shiny::renderPlot({
  ymax <- ears %>% select(get(input$the_var_ears)) %>% max(na.rm = T) %>% reshape::round_any(accuracy = 50, f = ceiling)
  
  ear_plot <- ggplot2::ggplot() + 
    ggplot2::ggtitle(input$the_var_ears) +
    ggplot2::expand_limits(y=0) +
    ggplot2::theme(axis.text = ggplot2::element_text(size=14),
                   axis.title = ggplot2::element_text(size=16,face="bold"),
                   legend.title = ggplot2::element_text(size=16,face="bold"),
                   legend.text = ggplot2::element_text(size=14),
                   plot.title = ggplot2::element_text(size=18,face="bold"))
  
  
  if(input$freeze_y_ears){
      ear_plot <- ear_plot + 
        ggplot2::ylim(c(0,ymax))
  }

  ear_plot <- ear_plot +  ggplot2::geom_boxplot(data=ears %>%
                                    dplyr::filter(Season == input$the_year_ears),
                                  ggplot2::aes(Garden, get(input$the_var_ears), fill = get(input$color_ears))) +
    ggplot2::ylab(paste0(input$the_var_ears," (g)"))
  
  ear_plot <- ear_plot +
    ggplot2::labs(fill = input$color_ears)
  
  ear_plot
  
}, width = "auto", height = 450)

shiny::downloadLink(outputId = 'download_ears', label = 'Download ear data')

# ears %>% 
#   dplyr::mutate(Garden = as.factor(Garden), Season = as.factor(Season)) %>%
#   dplyr::select(Season, Garden, Variety, `Ear weight`:Rows) %>%
#   dplyr::arrange(Season,Garden) %>%
#   dplyr::rename(`Ear weight (g)` = `Ear weight`, `Cob weight (g)` = `Cob weight`, `Kernel weight (g)` = `Kernel weight`) %>%
#   DT::datatable(
#     options = list(
#       pageLength = 10,
#       autoWidth = TRUE,
#       searching = FALSE,
#       dom = "rftiS",
#       scrollCollapse = TRUE,
#       scrollY = 400,
#       scrollX = FALSE,
#       deferRender = TRUE
#     ),
#     caption = 'Table 2: Ear measurements.',
#     rownames = FALSE
#   )
```

#### Yields through time
How much corn could have been expected in larger fields? How much corn would be needed to feed a family? How many fields?

```{r, echo=FALSE}

shiny::inputPanel(
  shiny::selectInput("the_var_yield", label = "Measurement:",
                     choices = c("Ear yield","Cob yield","Kernel yield"),
                     selected = "Kernel yield"),
  
  shiny::selectInput("color_yield", label = "Color by:",
                     choices = c("Garden"="Garden","Maize variety"="Variety"))
)

output$download_yields <- shiny::downloadHandler(
      filename = function() {
        "yields.csv"
      },
      content = function(con) {
        readr::write_csv(yields, con)
      }
    )

shiny::renderPlot({
# plotly::renderPlotly({
  yield_plot <- ggplot2::ggplot() + 
    ggplot2::ggtitle(input$the_var_yield) +
    ggplot2::ylab(paste0(input$the_var_yield," (kg/ha)")) +
    ggplot2::theme(axis.text = ggplot2::element_text(size=14),
                   axis.title = ggplot2::element_text(size=16,face="bold"),
                   legend.title = ggplot2::element_text(size=16,face="bold"),
                   legend.text = ggplot2::element_text(size=14),
                   plot.title = ggplot2::element_text(size=18,face="bold"))
  
  yield_plot <- yield_plot + ggplot2::geom_point(data = yields, na.rm = T, ggplot2::aes(y = get(input$the_var_yield), x = Season, colour = get(input$color_yield)), size=4) +
    ggplot2::ylab(paste0(input$the_var_yield," (kg/ha)")) +
    ggplot2::scale_colour_discrete(name = input$color_yield)
  
  yield_plot
  # plotly::ggplotly(yield_plot)
  
# })
}, width = "auto", height = 450)

shiny::downloadLink(outputId = 'download_yields', label = 'Download yield data')

# yields_table <- yields %>% 
#   dplyr::ungroup() %>%
#   dplyr::mutate(Garden = as.factor(Garden), Season = as.factor(Season)) %>%
#   dplyr::select(Season, Garden, Variety, `Ear yield`:`Kernel yield`) %>%
#   dplyr::arrange(Season,Garden) %>%
#   dplyr::rename(`Ear yield (kg/ha)` = `Ear yield`, `Cob yield (kg/ha)` = `Cob yield`, `Kernel yield (kg/ha)` = `Kernel yield`)
# 
# yields_table[,4:6] <- apply(X = yields_table[,4:6],MARGIN = 2,FUN = round)
# 
# DT::datatable(yields_table,
#               options = list(
#                 pageLength = 10,
#                 autoWidth = TRUE,
#                 searching = FALSE,
#                 dom = "rftiS",
#                 scrollCollapse = TRUE,
#                 scrollY = 400,
#                 scrollX = FALSE,
#                 deferRender = TRUE
#               ),
#               caption = 'Table 3: Garden yields.',
#               rownames = FALSE
# )

```

## What have we learned?
Review research questions. 

### Pueblo corn in the Mesa Verde region?
Hopi corn grows well in the CMV. Might be even better up in high areas during warm years. 

### Ancient yields?
Highly variable. People would have adapted to local environment. How quickly would people adapt? How quickly would corn adapt?